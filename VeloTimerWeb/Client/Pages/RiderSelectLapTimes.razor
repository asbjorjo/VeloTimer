@page "/rider/segmenttimes"
@page "/rider/segmenttimes/{Label}"
@layout MainLayout
@using VeloTimer.Shared.Models
@inject NavigationManager NavigationManager
@inject IApiClient Api
@inject HttpClient Http

<h3>Mine passeringstider</h3>

@if (segments == null || label == null || rider == null)
{
    <p>Laster...</p>
}
else
{
    <select @onchange="ChangeSegment">
        @foreach (var segment in segments)
        {
            <option value="@segment.StatisticsItem.Label" selected="@(segment.StatisticsItem.Label == this.label)">@segment.StatisticsItem.Label</option>
        }
    </select>
    <SegmentTimes Label=@label FromTime=DateTimeOffset.MinValue Count=100 Rider=@rider.UserId />
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    [Parameter]
    public string Label { get; set; }

    private IEnumerable<TrackStatisticsItem> segments;
    private string label;
    private Rider rider;

    protected async override Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        var user = (await authenticationStateTask).User;

        if (user.Identity.IsAuthenticated)
        {
            rider = await Api.GetRiderByUserId(user.FindFirst(c => c.Type == "sub")?.Value);
        }
    }

    protected override void OnParametersSet()
    {
        if (Label != null && Label != label)
        {
            label = Label;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        segments = await Api.GetStatisticsItems("1");
        label = segments.First().StatisticsItem.Label;
    }

    private void ChangeSegment(ChangeEventArgs e)
    {
        var selected = e.Value.ToString();
        NavigationManager.NavigateTo($"rider/segmenttimes/{selected}");
    }
}
